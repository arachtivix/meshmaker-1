name: CI and Deploy to Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run tests
      run: |
        export MPLBACKEND=Agg
        pytest --tb=short -v
    
    - name: Run example script
      run: |
        python example.py
    
    - name: Run maze example script
      run: |
        python example_maze.py
    
    - name: Run tree example script
      run: |
        python example_tree.py
    
    - name: Run organic growth example script
      run: |
        python example_organic_growth.py
    
    - name: Install Blender
      run: |
        sudo apt-get update
        sudo apt-get install -y blender
    
    - name: Render examples with Blender
      run: |
        mkdir -p blender_renders
        # Render house example
        blender --background --python render_with_blender.py -- example_house.obj blender_renders/house_render.png 1600 1200 64
        # Render tree example
        blender --background --python render_with_blender.py -- example_tree.obj blender_renders/tree_render.png 1600 1200 64
        # Render organic growth example
        blender --background --python render_with_blender.py -- example_organic_growth.obj blender_renders/organic_growth_render.png 1600 1200 64
        # Render maze with solution
        blender --background --python render_with_blender.py -- example_maze_solution.obj blender_renders/maze_render.png 1600 1200 64
        # Render small maze with solution
        blender --background --python render_with_blender.py -- example_maze_small_solution.obj blender_renders/maze_small_render.png 1600 1200 64
    
    - name: Create output directory for Pages
      run: |
        mkdir -p pages_output
        # Copy the generated OBJ files
        cp example_house.obj pages_output/
        cp example_maze.obj pages_output/
        cp example_maze_solution.obj pages_output/
        cp example_maze_small.obj pages_output/
        cp example_maze_small_solution.obj pages_output/
        cp example_tree.obj pages_output/
        cp example_organic_growth.obj pages_output/
        # Copy Blender renders
        if [ -d "blender_renders" ]; then
          cp -r blender_renders pages_output/
        fi
        # Copy any visual test outputs if they exist
        if [ -d "visual_tests_output" ]; then
          cp -r visual_tests_output pages_output/
        fi
    
    - name: Create index.html for GitHub Pages
      run: |
        cat > pages_output/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>MeshMaker Example Output</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 20px;
                    background-color: #f5f5f5;
                }
                h1 {
                    color: #333;
                    border-bottom: 3px solid #4CAF50;
                    padding-bottom: 10px;
                }
                h2 {
                    color: #555;
                    margin-top: 30px;
                }
                .info {
                    background-color: #fff;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    margin-bottom: 20px;
                }
                .download-section {
                    background-color: #e8f5e9;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 20px 0;
                }
                .download-link {
                    display: inline-block;
                    background-color: #4CAF50;
                    color: white;
                    padding: 10px 20px;
                    text-decoration: none;
                    border-radius: 4px;
                    margin: 5px;
                }
                .download-link:hover {
                    background-color: #45a049;
                }
                .gallery {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 20px;
                    margin-top: 20px;
                }
                .gallery-item {
                    background-color: #fff;
                    padding: 15px;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .gallery-item img {
                    width: 100%;
                    height: auto;
                    border-radius: 4px;
                }
                .gallery-item h3 {
                    margin-top: 10px;
                    color: #333;
                }
                footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 1px solid #ddd;
                    text-align: center;
                    color: #777;
                }
                code {
                    background-color: #f4f4f4;
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-family: 'Courier New', monospace;
                }
            </style>
        </head>
        <body>
            <h1>üè† MeshMaker Example Output</h1>
            
            <div class="info">
                <p>This page shows the output from the MeshMaker example scripts, including a house structure, a tree, and solvable mazes.</p>
                <p>Below you'll find Blender-rendered images with professional lighting, as well as downloadable 3D models and visual test outputs.</p>
                <p>Last updated: <strong id="update-time"></strong></p>
            </div>
            
            <h2>üé¨ Blender Rendered Examples</h2>
            <div class="info">
                <p>These images were rendered using Blender with professional three-point lighting to showcase the 3D models in high quality.</p>
            </div>
            <div id="blender-gallery" class="gallery">
                <!-- Blender renders will be added here by JavaScript -->
            </div>
            
            <div class="download-section">
                <h2>üì¶ Download 3D Models</h2>
                <h3>House Example</h3>
                <p>A simple house-like structure using a grid of colored cubes:</p>
                <a href="example_house.obj" class="download-link" download>Download example_house.obj</a>
                
                <h3 style="margin-top: 20px;">üå≤ Tree Example</h3>
                <p>A tree structure with a brown trunk and layered green foliage:</p>
                <a href="example_tree.obj" class="download-link" download>Download example_tree.obj</a>
                
                <h3 style="margin-top: 20px;">üåø Organic Growth Example</h3>
                <p>A randomly generated organic shape that grows by adding cubes according to specific rules:</p>
                <a href="example_organic_growth.obj" class="download-link" download>Download example_organic_growth.obj</a>
                <p style="margin-top: 5px; font-size: 0.85em; color: #666;">
                    Each run generates a unique shape! The shape grows from a single cube, adding new cubes that touch only one existing cube and have no corner-diagonal neighbors. The algorithm favors more open, branching structures.
                </p>
                
                <h3 style="margin-top: 20px;">üåÄ Maze Examples</h3>
                <p>Solvable mazes with parameterizable dimensions:</p>
                <a href="example_maze.obj" class="download-link" download>Download example_maze.obj (15x15)</a>
                <a href="example_maze_solution.obj" class="download-link" download>Download example_maze_solution.obj (15x15 with solution)</a>
                <br>
                <a href="example_maze_small.obj" class="download-link" download>Download example_maze_small.obj (9x9)</a>
                <a href="example_maze_small_solution.obj" class="download-link" download>Download example_maze_small_solution.obj (9x9 with solution)</a>
                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    The OBJ files can be opened in 3D modeling software like Blender, MeshLab, or online viewers.
                    The solution path is shown in a distinct color (yellow/gold for large mazes, green for small mazes).
                </p>
            </div>
            
            <h2>üé® Visual Test Gallery</h2>
            <div id="gallery" class="gallery">
                <!-- Gallery items will be added here by JavaScript -->
            </div>
            
            <div class="info" style="margin-top: 30px;">
                <h2>About MeshMaker</h2>
                <p>MeshMaker is a Python library for creating 3D meshes based on a grid of cubes. Each cube can be occupied or unoccupied, with customizable appearance properties including color, transparency, and material.</p>
                <p>
                    <strong>Features:</strong>
                </p>
                <ul>
                    <li>Grid-based 3D mesh generation</li>
                    <li>Parameterizable appearance (color, transparency, material)</li>
                    <li>Solvable maze generation with customizable dimensions</li>
                    <li>Solution path visualization</li>
                    <li>Export to OBJ format</li>
                    <li>Comprehensive testing with visual outputs</li>
                </ul>
            </div>
            
            <footer>
                <p>Generated by GitHub Actions | <a href="https://github.com/arachtivix/meshmaker-1">View Repository</a></p>
            </footer>
            
            <script>
                // Set update time
                document.getElementById('update-time').textContent = new Date().toLocaleString();
                
                // Define Blender rendered images
                const blenderRenders = [
                    { name: 'House Structure', file: 'house_render.png', description: 'House-like structure with colored cubes rendered with Blender lighting' },
                    { name: 'Tree Structure', file: 'tree_render.png', description: 'Tree with brown trunk and green foliage rendered with professional lighting' },
                    { name: 'Organic Growth', file: 'organic_growth_render.png', description: 'Randomly generated organic shape with branching structure and gradient coloring' },
                    { name: 'Maze with Solution (15x15)', file: 'maze_render.png', description: 'Large solvable maze with blue walls and yellow solution path' },
                    { name: 'Maze with Solution (9x9)', file: 'maze_small_render.png', description: 'Small solvable maze with red walls and green solution path' }
                ];
                
                // Create Blender render gallery items
                const blenderGallery = document.getElementById('blender-gallery');
                blenderRenders.forEach(render => {
                    const item = document.createElement('div');
                    item.className = 'gallery-item';
                    
                    const img = document.createElement('img');
                    img.src = `blender_renders/${render.file}`;
                    img.alt = render.name;
                    img.onerror = function() {
                        this.parentElement.style.display = 'none';
                    };
                    
                    const title = document.createElement('h3');
                    title.textContent = render.name;
                    
                    const desc = document.createElement('p');
                    desc.textContent = render.description;
                    desc.style.fontSize = '0.9em';
                    desc.style.color = '#666';
                    
                    item.appendChild(img);
                    item.appendChild(title);
                    item.appendChild(desc);
                    blenderGallery.appendChild(item);
                });
                
                // Define visual test images
                const visualTests = [
                    { name: 'Single Cube', file: 'single_cube.png', description: 'A single blue cube in 3D space' },
                    { name: 'Multiple Cubes', file: 'multiple_cubes.png', description: 'Pattern of red, green, and blue cubes' },
                    { name: 'Cross Structure', file: 'cross_structure.png', description: 'Yellow cross-shaped structure' },
                    { name: 'Transparency', file: 'transparency.png', description: 'Cubes with different transparency levels' },
                    { name: 'Maze with Solution', file: 'maze_with_solution.png', description: '9x9 solvable maze with blue walls and yellow solution path' }
                ];
                
                // Create gallery items
                const gallery = document.getElementById('gallery');
                visualTests.forEach(test => {
                    const item = document.createElement('div');
                    item.className = 'gallery-item';
                    
                    const img = document.createElement('img');
                    img.src = `visual_tests_output/${test.file}`;
                    img.alt = test.name;
                    img.onerror = function() {
                        this.parentElement.style.display = 'none';
                    };
                    
                    const title = document.createElement('h3');
                    title.textContent = test.name;
                    
                    const desc = document.createElement('p');
                    desc.textContent = test.description;
                    desc.style.fontSize = '0.9em';
                    desc.style.color = '#666';
                    
                    item.appendChild(img);
                    item.appendChild(title);
                    item.appendChild(desc);
                    gallery.appendChild(item);
                });
            </script>
        </body>
        </html>
        EOF
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'pages_output'
  
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: test-and-build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
